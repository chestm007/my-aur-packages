
# Common sections
defaults: &defaults
  working_directory: ~/aur
  docker:
    - image: imrehg/archlinux-makepkg

updatepackage: &updatepackage
  name: Update packages
  command: |
    sudo pacman -Syu --noconfirm
    sudo sed -i 's/^#MAKEFLAGS=.*/MAKEFLAGS="-j$(nproc)"/g' /etc/makepkg.conf

gitupdate: &gitupdate
  name: Git repo updates
  command: |
    sed -i "s#ssh+git://aur@aur.archlinux.org#https://aur.archlinux.org#" .gitmodules
    git submodule update --init

pkgbuildtest: &pkgbuildtest
  name: Testing PKGBUILD
  command: |
    cd ~/aur/${CIRCLE_JOB}
    namcap PKGBUILD

buildtest: &buildtest
  name: Building package
  command: |
    cd ~/aur/${CIRCLE_JOB}
    makepkg -sci --noconfirm

install_cassandra: &install_cassandra
  name: Build and install cassandra package from aur
  command: |
    cd ~/
    git clone https://aur.archlinux.org/cassandra.git
    cd cassandra
    makepkg -si --noconfirm --skippgpcheck

install_deb2targz: &install_deb2targz
  name: Build and install deb2targz from aur
  command: |
    cd ~/
    git clone https://aur.archlinux.org/deb2targz.git
    cd deb2targz
    makepkg -si --noconfirm

install_zxcvbn: &install_zxcvbn
  name: Build and install zxcvbn from aur
  command: |
    cd ~/
    sudo pacman -S python2 python2-setuptools --noconfirm
    sudo pacman -S python python-setuptools --noconfirm
    git clone https://aur.archlinux.org/python2-zxcvbn.git
    cd python2-zxcvbn
    makepkg -s package_python-zxcvbn --noconfirm
    sudo pacman -U python-zxcvbn* --noconfirm

# Main
version: 2
jobs:
  linux-asus-aura:
    <<: *defaults
    steps:
      - run:
          <<: *updatepackage
      - run:
          name: add key to pacman
          command: |
            sudo pacman-key --recv-keys A5E9288C4FA415FA
            sudo gpg --recv-keys A5E9288C4FA415FA
      - checkout
      - run:
          <<: *gitupdate
      - run:
          <<: *pkgbuildtest
      - run:
          <<: *buildtest
  amdgpu-fan:
    <<: *defaults
    steps:
      - run:
          <<: *updatepackage
      - checkout
      - run:
          <<: *gitupdate
      - run:
          <<: *pkgbuildtest
      - run:
          <<: *buildtest
  linux-thermaltake-rgb:
    <<: *defaults
    steps:
      - run:
          <<: *updatepackage
      - checkout
      - run:
          <<: *gitupdate
      - run:
          <<: *pkgbuildtest
      - run:
          <<: *buildtest
  kairosdb:
    <<: *defaults
    steps:
      - run:
          <<: *updatepackage
      - run:
          <<: *install_cassandra
      - run:
          <<: *install_deb2targz
      - checkout
      - run:
          <<: *gitupdate
      - run:
          <<: *pkgbuildtest
      - run:
          <<: *buildtest
  python2-cassandra-driver-git:
    <<: *defaults
    steps:
      - run:
          <<: *updatepackage
      - checkout
      - run:
          <<: *gitupdate
      - run:
          <<: *pkgbuildtest
      - run:
          <<: *buildtest
      - run:
          name: yeah
          command: ls /home/builder/aur/python2-cassandra-driver-git
      - persist_to_workspace:
          root: python2-cassandra-driver-git
          paths: python2-cassandra-driver-git-*.pkg.tar
  cqlsh:
    <<: *defaults
    steps:
      - run:
          <<: *updatepackage
      - run:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: install python2-cassandra-driver
          command: sudo pacman -U --noconfirm /tmp/workspace/python2-cassandra-driver-git-*.pkg.tar
      - checkout
      - run:
          <<: *gitupdate
      - run:
          <<: *pkgbuildtest
      - run:
          <<: *buildtest
  python-cassandra-driver-git:
    <<: *defaults
    steps:
      - run:
          <<: *updatepackage
      - checkout
      - run:
          <<: *gitupdate
      - run:
          <<: *pkgbuildtest
      - run:
          <<: *buildtest
  flexget-git:
    <<: *defaults
    steps:
      - run:
          <<: *updatepackage
      - run:
          <<: *install_zxcvbn
      - checkout
      - run:
          <<: *gitupdate
      - run:
          <<: *pkgbuildtest
      - run:
          <<: *buildtest

workflows:
  version: 2
  build:
    jobs:
      - linux-asus-aura
      - linux-thermaltake-rgb
      - kairosdb
      - amdgpu-fan
      - python2-cassandra-driver-git
      # - flexget-git
      - python-cassandra-driver-git
      - cqlsh:
          requires:
            - python2-cassandra-driver-git
